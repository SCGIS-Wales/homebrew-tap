# .github/workflows/bottles.yml
name: Build Homebrew bottles

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

jobs:
  bottle:
    strategy:
      fail-fast: false
      matrix:
        runner: [macos-13, macos-14]  # 13 ≈ Intel, 14 ≈ Apple Silicon
    runs-on: ${{ matrix.runner }}

    permissions:
      contents: write

    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Style and audit formula
        env:
          TAP_REPO: ${{ github.repository }}   # e.g. scgis-wales/homebrew-tap
          FORMULA: dcert
        run: |
          set -euo pipefail
          brew update
          # Style can take a path or a name. Using the name is future proof.
          brew style --fix "$FORMULA"
          # Audit must not use a path. Audit the tap, or just the formula by name.
          brew audit --formula --online --strict --tap="$TAP_REPO"

      - name: Build bottle with test-bot
        env:
          TAP_REPO: ${{ github.repository }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          brew test-bot \
            --only-formulae \
            --tap="$TAP_REPO" \
            --keep-old \
            --fail-fast \
            --skip-recursive-dependents \
            --root-url="https://github.com/${TAP_REPO}/releases/download/${TAG_NAME}"

      - name: Upload bottles to the tag release
        uses: softprops/action-gh-release@v2
        if: always()
        with:
          tag_name: ${{ github.ref_name }}
          files: "*.bottle.*"
          generate_release_notes: false
